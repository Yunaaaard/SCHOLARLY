<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Profile - Scholarly</title>
  <link 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" 
    rel="stylesheet">
  <link rel="stylesheet" href="assets/css/dashboard.css">
</head>
<body>
  <div class="dashboard d-flex">
    <!-- Sidebar -->
    <aside class="sidebar d-flex flex-column align-items-center p-3">
      <img src="assets/images/Group 44.png" alt="Scholarly Logo" class="logo mb-4">
      <div class="profile text-center mb-4">
        <img src="assets/Images/profile.png" alt="Profile" class="profile-img mb-2">
        <h2 id="sidebarName" class="h5 fw-bold">Leonard Tariman</h2>
        <p class="small mb-2">STUDENT</p>
        <button class="btn btn-primary rounded-pill disabled">Edit Profile</button>
      </div>
      <hr class="w-100">

      <nav class="nav flex-column w-100">
        <a href="dashboard.html" class="nav-link d-flex align-items-center gap-2 text-white">
          <img src="https://storage.googleapis.com/tagjs-prod.appspot.com/v1/P11DPD00iM/ypvgcziq_expires_30_days.png"> Home
        </a>
        <a href="settings.html" class="nav-link d-flex align-items-center gap-2 text-white">
          <img src="https://storage.googleapis.com/tagjs-prod.appspot.com/v1/P11DPD00iM/xqldtbo1_expires_30_days.png"> Settings
        </a>
        <a href="#" class="nav-link d-flex align-items-center gap-2 text-white">
          <img src="https://storage.googleapis.com/tagjs-prod.appspot.com/v1/P11DPD00iM/ed6vfccw_expires_30_days.png"> Bookmarks
        </a>
        <a href="index.html" class="nav-link d-flex align-items-center gap-2 text-white">
          <img src="https://storage.googleapis.com/tagjs-prod.appspot.com/v1/P11DPD00iM/2y4kk645_expires_30_days.png"> Logout
        </a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content flex-grow-1 p-4">
      <h2 class="fw-bold mb-4">Edit Profile</h2>

      <form class="w-75" id="editForm" enctype="multipart/form-data">
        <div class="mb-3">
          <label for="profilePic" class="form-label">Profile Picture</label>
          <input type="file" class="form-control" id="profilePic" accept="image/*">
          <div class="form-text">Accepted formats: JPG, PNG, GIF. Max size: 5MB</div>
        </div>

        <div class="mb-3">
          <label for="fullName" class="form-label">Full Name</label>
          <input type="text" class="form-control" id="fullName" value="Leonard Tariman" required>
        </div>

        <div class="mb-3">
          <label for="role" class="form-label">Role</label>
          <input type="text" class="form-control" id="role" value="STUDENT" disabled>
        </div>

        <div class="mb-3">
          <label for="email" class="form-label">Email</label>
          <input type="email" class="form-control" id="email" value="" readonly>
        </div>

        <div class="mb-3">
          <label for="contact" class="form-label">Contact</label>
          <input type="text" class="form-control" id="contact" value="">
        </div>

        <div class="mb-3">
          <label for="password" class="form-label">New Password</label>
          <input type="password" class="form-control" id="password" placeholder="Enter new password">
        </div>

        <button type="submit" class="btn btn-primary rounded-pill">Save Changes</button>
        <a href="dashboard.php" class="btn btn-outline-secondary rounded-pill ms-2">Cancel</a>
      </form>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="user-hydrate.js.php"></script>
  <script>
    (function() {
      fetch('api-user-profile.php', { credentials: 'same-origin' })
        .then(function(r) { return r.ok ? r.json() : Promise.reject(); })
        .then(function(data) {
          try {
            if (data.username) {
              document.getElementById('fullName').value = data.username;
              document.getElementById('sidebarName').textContent = data.username;
            }
            if (data.email) {
              document.getElementById('email').value = data.email;
            }
            if (document.getElementById('contact')) {
              document.getElementById('contact').value = data.contact || '';
            }
          } catch (e) {}
        }).catch(function(){ /* ignore */ });

      var form = document.getElementById('editForm');
      if (form) {
        form.addEventListener('submit', function(ev){
          ev.preventDefault();
          var username = document.getElementById('fullName').value.trim();
          var email = document.getElementById('email').value.trim();
          var contact = document.getElementById('contact').value.trim();
          var profilePic = document.getElementById('profilePic').files[0];
          
          if (!username || !email) { return; }
          
          var fd = new FormData();
          fd.append('username', username);
          fd.append('email', email);
          fd.append('contact', contact);
          if (profilePic) {
            fd.append('profilePic', profilePic);
          }
          
          fetch('api-user-profile.php', {
            method: 'POST',
            credentials: 'same-origin',
            body: fd
          }).then(function(r){
            return r.json().then(function(j){ return { ok: r.ok, status: r.status, body: j }; });
          }).then(function(res){
            var alertDiv = document.createElement('div');
            alertDiv.className = 'alert mt-3 ' + (res.ok ? 'alert-success' : 'alert-danger');
            alertDiv.textContent = res.ok ? 'Profile updated successfully.' : (res.body && res.body.error ? res.body.error : 'Update failed');
            form.appendChild(alertDiv);
            setTimeout(function(){ alertDiv.remove(); }, 3000);
          }).catch(function(){
            var alertDiv = document.createElement('div');
            alertDiv.className = 'alert mt-3 alert-danger';
            alertDiv.textContent = 'Network error. Please try again.';
            form.appendChild(alertDiv);
            setTimeout(function(){ alertDiv.remove(); }, 3000);
          });
        });
      }
    })();
  </script>
</body>
</html>
