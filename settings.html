<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scholarly Settings</title>
  <link 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" 
    rel="stylesheet">
  <link rel="stylesheet" href="assets/css/dashboard.css">
  <style>
    .settings-section {
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid #dee2e6;
    }
    .settings-section:last-child {
      border-bottom: none;
    }
    .settings-section h5 {
      font-weight: bold;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <div class="dashboard d-flex">
    <aside class="sidebar d-flex flex-column align-items-center p-3">
      <img src="assets/images/Group 44.png" alt="Scholarly Logo" class="logo mb-4">
      <div class="profile text-center mb-4">
        <img src="assets/Images/profile.png" alt="Profile" class="profile-img mb-2">
        <h2 id="sidebarName" class="h5 fw-bold">Leonard Tariman</h2>
        <p class="small mb-2">STUDENT</p>
        <button class="btn btn-primary rounded-pill">Edit Profile</button>
      </div>
      <hr class="w-100">

      <nav class="nav flex-column w-100">
        <a href="dashboard.php" class="nav-link d-flex align-items-center gap-2 text-white">
          <img src="https://storage.googleapis.com/tagjs-prod.appspot.com/v1/P11DPD00iM/ypvgcziq_expires_30_days.png"> Home
        </a>
        <a href="settings.html" class="nav-link d-flex align-items-center gap-2 text-white active">
          <img src="https://storage.googleapis.com/tagjs-prod.appspot.com/v1/P11DPD00iM/xqldtbo1_expires_30_days.png"> Settings
        </a>
        <a href="bookmark.html" class="nav-link d-flex align-items-center gap-2 text-white">
          <img src="https://storage.googleapis.com/tagjs-prod.appspot.com/v1/P11DPD00iM/ed6vfccw_expires_30_days.png"> Bookmarks
        </a>
        <a href="index.html" class="nav-link d-flex align-items-center gap-2 text-white">
          <img src="https://storage.googleapis.com/tagjs-prod.appspot.com/v1/P11DPD00iM/2y4kk645_expires_30_days.png"> Logout
        </a>
      </nav>
    </aside>
    <main class="main-content flex-grow-1 p-4">
      <h2 class="fw-bold mb-4">Settings</h2>
      <div class="settings-container">
        <div class="settings-section">
          <h5>Account Information</h5>
          <form id="accountForm">
            <div class="mb-3">
              <label class="form-label">Username</label>
              <input id="setUsername" type="text" class="form-control" value="Leonard Tariman">
            </div>
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input id="setEmail" type="email" class="form-control" value="leonard@example.com">
            </div>
            <div class="mb-3">
              <label class="form-label">Contact Number</label>
              <input id="setContact" type="text" class="form-control" value="+63 912 345 6789">
            </div>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </form>
        </div>
        <div class="settings-section">
          <h5>Change Password</h5>
          <form id="passwordForm">
            <div class="mb-3">
              <label class="form-label">Current Password</label>
              <input type="password" class="form-control">
            </div>
            <div class="mb-3">
              <label class="form-label">New Password</label>
              <input type="password" class="form-control">
            </div>
            <div class="mb-3">
              <label class="form-label">Confirm New Password</label>
              <input type="password" class="form-control">
            </div>
            <button type="submit" class="btn btn-primary">Update Password</button>
          </form>
        </div>
        <div class="settings-section">
          <h5>Preferences</h5>
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="notifications" checked>
            <label class="form-check-label" for="notifications">
              Enable Notifications
            </label>
          </div>
          <button class="btn btn-primary mt-2">Save Preferences</button>
        </div>
      </div>
    </main>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="user-hydrate.js.php"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      fetch('api-user-profile.php', { credentials: 'same-origin', cache: 'no-store' })
        .then(function(r){
          if (r.status === 401) { window.location.href = 'login.html'; return Promise.reject(); }
          if (!r.ok) { return Promise.reject(); }
          return r.json();
        })
        .then(function(data){
          try {
            var u = (data && data.username) ? data.username : '';
            var e = (data && data.email) ? data.email : '';
            var c = (data && data.contact) ? data.contact : '';
            var elUser = document.getElementById('setUsername');
            var elEmail = document.getElementById('setEmail');
            var elContact = document.getElementById('setContact');
            var elSidebar = document.getElementById('sidebarName');
            if (elUser) elUser.value = u;
            if (elEmail) elEmail.value = e;
            if (elContact) elContact.value = c;
            if (elSidebar && u) elSidebar.textContent = u;
          } catch(e) { /* ignore */ }
        })
        .catch(function(){ /* ignore */ });

      var accountForm = document.getElementById('accountForm');
      if (accountForm) {
        accountForm.addEventListener('submit', function(ev){
          ev.preventDefault();
          var username = document.getElementById('setUsername').value.trim();
          var email = document.getElementById('setEmail').value.trim();
          var contact = document.getElementById('setContact').value.trim();
          var fd = new FormData();
          fd.append('username', username);
          fd.append('email', email);
          fd.append('contact', contact);
          fetch('api-user-profile.php', {
            method: 'POST',
            credentials: 'same-origin',
            body: fd
          }).then(function(r){
            return r.json().then(function(j){ return { ok: r.ok, status: r.status, body: j }; });
          }).then(function(res){
            var alertDiv = document.createElement('div');
            alertDiv.className = 'alert mt-3 ' + (res.ok ? 'alert-success' : 'alert-danger');
            alertDiv.textContent = res.ok ? 'Profile updated successfully.' : (res.body && res.body.error ? res.body.error : 'Update failed');
            accountForm.appendChild(alertDiv);
            setTimeout(function(){ alertDiv.remove(); }, 3000);
            if (res.ok && username) {
              var elSidebar = document.getElementById('sidebarName');
              if (elSidebar) elSidebar.textContent = username;
            }
          }).catch(function(){
            var alertDiv = document.createElement('div');
            alertDiv.className = 'alert mt-3 alert-danger';
            alertDiv.textContent = 'Network error. Please try again.';
            accountForm.appendChild(alertDiv);
            setTimeout(function(){ alertDiv.remove(); }, 3000);
          });
        });
      }
    });
  </script>
</body>
</html>
