<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scholarly Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/dashboard.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>    
  <div class="dashboard d-flex">
    <aside class="sidebar d-flex flex-column align-items-center p-3">
  <img src="assets/images/Group 44.png" alt="Scholarly Logo" class="logo mb-4 sidebar-logo">
  
  <div class="profile text-center mb-4">
    <img src="assets/Images/profile.png" alt="Profile" class="profile-img mb-2 big-circle">
    <h2 id="sidebarName" class="h5 fw-bold">Leonard Tariman</h2>
    <p class="small mb-2">STUDENT</p>
    <button class="btn btn-primary rounded-pill" onclick="window.location.href='edit.html'">Edit Profile</button>
  </div>

  <hr class="w-100">

  <nav class="nav flex-column w-100">
    <a href="dashboard.html" class="nav-link d-flex align-items-center gap-2 text-white active">
      <i class="bi bi-house-door"></i> Home
    </a>
    <a href="settings.html" class="nav-link d-flex align-items-center gap-2 text-white">
      <i class="bi bi-gear"></i> Settings
    </a>
    <a href="bookmark.html" class="nav-link d-flex align-items-center gap-2 text-white">
      <i class="bi bi-bookmark"></i> Bookmarks
    </a>
    <a href="logout.php" class="nav-link d-flex align-items-center gap-2 text-white" 
   data-bs-toggle="modal" data-bs-target="#logoutModal">
  <i class="bi bi-box-arrow-right"></i> Logout
</a>
  </nav>

  <div class="modal fade" id="logoutModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content logout-modal">
      <div class="modal-body text-center py-4">
        <i class="bi bi-box-arrow-right text-danger mb-3" style="font-size:3rem;"></i>
        <h5 class="fw-bold text-dark mb-2">Are you sure you want to log out?</h5>
        <p class="text-muted small">You will be redirected to the login page.</p>
        <div class="d-flex justify-content-center gap-3 mt-3">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <a href="logout.php" class="btn btn-danger px-4">Logout</a>
        </div>
      </div>
    </div>
  </div>
</div>
  <!-- Custom toggle button with arrow image -->
  <button class="sidebar-toggle" id="sidebarToggle">
  <img src="assets/Images/left_arrow.png" alt="Toggle Sidebar" class="arrow-icon">
</button>
</aside>

      <main class="main-content flex-grow-1 p-4">
    <div class="controls d-flex justify-content-between align-items-center mb-4">
  <div class="search-container position-relative">
    <i class="bi bi-search position-absolute" 
       style="top: 50%; left: 12px; transform: translateY(-50%); color: #6c757d;"></i>
    <input type="text" 
           class="form-control search-input ps-5" 
           placeholder="Search available scholarships">
  </div>
  <div class="filter-sort d-flex gap-2">
    <button class="btn btn-outline-secondary filter-btn d-flex align-items-center gap-1">
      <i class="bi bi-funnel"></i>
      FILTER
    </button>
    <button class="btn btn-outline-secondary sort-btn d-flex align-items-center gap-1">
      <i class="bi bi-arrow-down-up"></i>
      SORT
    </button>
  </div>
</div>
    <div id="scholarshipCards" class="cards d-flex flex-column gap-3"></div>
  </main>
  </div>

  <!-- Scholarship Detail Modal -->
  <div id="scholarshipModal" class="modal fade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="scholarship-detail">
            <div class="scholarship-header d-flex align-items-center gap-3 mb-4">
              <img id="modalLogo" src="" alt="Logo" class="scholarship-logo">
              <div>
                <h2 id="modalTitle" class="scholarship-title mb-1"></h2>
                <p id="modalSponsor" class="scholarship-sponsor mb-0"></p>
              </div>
            </div>
            
            <div class="scholarship-content">
              <div class="eligibility-section mb-4">
                <h5 class="section-title text-primary mb-3">Eligibility</h5>
                <ul id="modalEligibility" class="eligibility-list"></ul>
              </div>
              
              <div class="benefits-section mb-4">
                <h5 class="section-title mb-3">
                  <span class="benefits-icon">ðŸŽ“</span> Benefits
                </h5>
                <ul id="modalBenefits" class="benefits-list"></ul>
              </div>
              
              <div class="requirements-section mb-4">
                <h5 class="section-title mb-3">
                  <span class="requirements-icon">âœ…</span> Application Requirements
                </h5>
                <ul id="modalRequirements" class="requirements-list"></ul>
              </div>
              
              <div class="scholarship-meta d-flex justify-content-between align-items-center mb-4">
                <div>
                  <strong>DATE OF EFFECT:</strong> <span id="modalDate"></span>
                </div>
                <div>
                  <strong>CONTACT & DETAILS:</strong> <span id="modalContact"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary btn-apply" id="applyBtn">APPLY</button>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="user-hydrate.js.php"></script>
  <script>
    (function() {
      // Populate user sidebar name
      fetch('api-user-profile.php', { credentials: 'same-origin' })
        .then(function(r){ return r.ok ? r.json() : Promise.reject(); })
        .then(function(data){ 
          if (data.username) document.getElementById('sidebarName').textContent = data.username;
          if (data.profile_picture) {
            var imgEl = document.querySelector('.profile-img');
            if (imgEl) imgEl.src = data.profile_picture;
          }
        })
        .catch(function(){});

      // Render scholarships with bookmark functionality
      fetch('api-scholarships.php', { credentials: 'same-origin' })
        .then(function(r){ return r.ok ? r.json() : Promise.reject(); })
        .then(function(items){
          var wrap = document.getElementById('scholarshipCards');
          if (!Array.isArray(items) || !wrap) return;

          var allItems = items.slice(0);
          var sortAsc = true;
          var currentCategory = '';

          function clearWrap() {
            while (wrap.firstChild) wrap.removeChild(wrap.firstChild);
          }

          function render(list) {
            clearWrap();
            if (!list || list.length === 0) {
              var info = document.createElement('div');
              info.className = 'alert alert-info mb-0';
              info.textContent = 'No scholarships available.';
              wrap.appendChild(info);
              return;
            }
            list.forEach(function(s){
              var card = document.createElement('div');
              card.className = 'card position-relative';

              var left = document.createElement('div');
              left.className = 'card-left';
              var img = document.createElement('img');
              img.alt = 'logo';
              img.src = s.image_path && s.image_path.length ? s.image_path : 'assets/Images/image.png';
              left.appendChild(img);

              var middle = document.createElement('div');
              middle.className = 'card-middle';
              var title = document.createElement('h3');
              title.className = 'card-title';
              title.textContent = s.title || '';
              var sponsor = document.createElement('p');
              sponsor.className = 'card-sponsor';
              sponsor.textContent = s.sponsor || '';
              middle.appendChild(title);
              middle.appendChild(sponsor);

              var right = document.createElement('div');
              right.className = 'card-right';

              var bookmarkIcon = document.createElement('button');
              bookmarkIcon.className = 'bookmark-icon';
              bookmarkIcon.onclick = function(){ toggleBookmark(s.id, bookmarkIcon); };

              var btn = document.createElement('button');
              btn.className = 'btn btn-primary';
              btn.textContent = 'VIEW';
              btn.onclick = function(){ showScholarshipDetails(s.id); };

              right.appendChild(bookmarkIcon);
              right.appendChild(btn);

              card.appendChild(left);
              card.appendChild(middle);
              card.appendChild(right);
              wrap.appendChild(card);
            });
          }

          function applyFilters() {
            var q = (document.querySelector('.search-input')?.value || '').toLowerCase();
            var filtered = allItems.filter(function(it){
              var t = (it.title || '').toLowerCase();
              var sp = (it.sponsor || '').toLowerCase();
              var catOk = currentCategory ? (it.category === currentCategory) : true;
              var qOk = !q || t.indexOf(q) !== -1 || sp.indexOf(q) !== -1;
              return catOk && qOk;
            });
            filtered.sort(function(a, b){
              var at = (a.title || '').toLowerCase();
              var bt = (b.title || '').toLowerCase();
              if (at < bt) return sortAsc ? -1 : 1;
              if (at > bt) return sortAsc ? 1 : -1;
              return 0;
            });
            return filtered;
          }

          // Initial render
          render(applyFilters());

          // Wire up search
          var searchEl = document.querySelector('.search-input');
          if (searchEl) {
            searchEl.addEventListener('input', function(){
              render(applyFilters());
            });
          }

          // Wire up sort (toggle A-Z / Z-A by title)
          var sortBtn = document.querySelector('.sort-btn');
          if (sortBtn) {
            sortBtn.addEventListener('click', function(){
              sortAsc = !sortAsc;
              render(applyFilters());
            });
          }

          // Wire up filter (category) - build a small dropdown dynamically
          var filterBtn = document.querySelector('.filter-btn');
          if (filterBtn) {
            var container = document.querySelector('.filter-sort');
            var select = document.createElement('select');
            select.className = 'form-select';
            select.style.maxWidth = '180px';
            select.style.display = 'none';
            var optAll = document.createElement('option'); optAll.value = ''; optAll.textContent = 'All Categories'; select.appendChild(optAll);
            var cats = Array.from(new Set(allItems.map(function(it){ return it.category || ''; }).filter(Boolean)));
            cats.forEach(function(c){ var o = document.createElement('option'); o.value = c; o.textContent = c; select.appendChild(o); });
            container.insertBefore(select, container.firstChild);

            filterBtn.addEventListener('click', function(){
              select.style.display = (select.style.display === 'none') ? 'block' : 'none';
            });
            select.addEventListener('change', function(){
              currentCategory = select.value || '';
              render(applyFilters());
            });
          }
        })
        .catch(function(){});
    })();

    function toggleBookmark(scholarshipId, iconElement) {
      fetch('api-bookmarks.php', {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ scholarship_id: scholarshipId, action: 'toggle' })
      })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.success) {
          if (data.bookmarked) {
            iconElement.classList.add('bookmarked');
          } else {
            iconElement.classList.remove('bookmarked');
          }
        }
      })
      .catch(function() {});
    }


  const sidebar = document.querySelector('.sidebar');
  const toggle = document.querySelector('.sidebar-toggle');
  
  toggle.addEventListener('click', () => {
    sidebar.classList.toggle('collapsed');
  });



    var currentScholarshipId = null;

    function showScholarshipDetails(scholarshipId) {
      currentScholarshipId = scholarshipId;
      fetch('api-scholarships.php?id=' + scholarshipId, { credentials: 'same-origin' })
        .then(function(r) { return r.ok ? r.json() : Promise.reject(); })
        .then(function(data) {
          // Populate modal with scholarship data
          document.getElementById('modalLogo').src = data.image_path || 'assets/Images/image.png';
          document.getElementById('modalTitle').textContent = data.title || '';
          document.getElementById('modalSponsor').textContent = data.sponsor || '';
          
          // Display description in eligibility section (since we don't have separate fields)
          var eligibilityList = document.getElementById('modalEligibility');
          eligibilityList.innerHTML = '';
          if (data.description) {
            var li = document.createElement('li');
            li.textContent = data.description;
            eligibilityList.appendChild(li);
          }
          
          // Hide benefits and requirements sections since we don't have this data
          document.querySelector('.benefits-section').style.display = 'none';
          document.querySelector('.requirements-section').style.display = 'none';
          
          // Display date range and contact
          var dateRange = '';
          if (data.start_date && data.end_date) {
            dateRange = data.start_date + ' - ' + data.end_date;
          } else if (data.start_date) {
            dateRange = 'From ' + data.start_date;
          } else if (data.end_date) {
            dateRange = 'Until ' + data.end_date;
          } else {
            dateRange = 'N/A';
          }
          document.getElementById('modalDate').textContent = dateRange;
          document.getElementById('modalContact').textContent = data.email || data.phone || 'N/A';
          
          // Reset apply button
          var applyBtn = document.getElementById('applyBtn');
          if (applyBtn) { applyBtn.style.display = 'none'; }
          
          // Show modal
          var modal = new bootstrap.Modal(document.getElementById('scholarshipModal'));
          modal.show();
        })
        .catch(function() {
          alert('Failed to load scholarship details');
        });
    }

    function submitApplication(scholarshipId) {
      var applyBtn = document.getElementById('applyBtn');
      applyBtn.disabled = true;
      applyBtn.textContent = 'APPLYING...';
      
      var formData = new FormData();
      formData.append('scholarship_id', scholarshipId);
      
      fetch('api-applications.php', {
        method: 'POST',
        body: formData,
        credentials: 'same-origin'
      })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.success) {
          applyBtn.textContent = 'APPLIED âœ“';
          applyBtn.style.backgroundColor = '#28a745';
          alert('Application submitted successfully!');
        } else {
          applyBtn.textContent = 'APPLY';
          applyBtn.disabled = false;
          alert(data.error || 'Failed to submit application');
        }
      })
      .catch(function() {
        applyBtn.textContent = 'APPLY';
        applyBtn.disabled = false;
        alert('Failed to submit application');
      });
    }
  </script>
</body>
</html>
